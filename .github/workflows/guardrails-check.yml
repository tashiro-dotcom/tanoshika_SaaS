name: guardrails-check

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  require-doc-updates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce guardrail docs update for implementation changes
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail

          CHANGED_FILES=$(git diff --name-only "$BASE_SHA...$HEAD_SHA")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed files. Skip."
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          REQUIRES_DOC_UPDATE=$(echo "$CHANGED_FILES" | grep -E -v '^(docs/PROJECT_GUARDRAILS.md|docs/DECISIONS_LOG.md|docs/NEXT_ACTIONS.md|docs/.*\.md|README\.md)$' || true)

          if [ -z "$REQUIRES_DOC_UPDATE" ]; then
            echo "Only documentation changed. Guardrail doc update is optional."
            exit 0
          fi

          DOCS_UPDATED=$(echo "$CHANGED_FILES" | grep -E '^(docs/PROJECT_GUARDRAILS.md|docs/DECISIONS_LOG.md|docs/NEXT_ACTIONS.md)$' || true)

          if [ -z "$DOCS_UPDATED" ]; then
            echo "ERROR: Implementation changes detected, but guardrail docs were not updated."
            echo "Please update at least one of:"
            echo "- docs/PROJECT_GUARDRAILS.md"
            echo "- docs/DECISIONS_LOG.md"
            echo "- docs/NEXT_ACTIONS.md"
            exit 1
          fi

          echo "Guardrail docs updated. Check passed."
